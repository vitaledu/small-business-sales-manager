<div class="page-header">
  <div>
    <h1>Nova Compra</h1>
    <p>Registrar entrada de produtos no estoque</p>
  </div>
  <a href="/compras" class="btn btn-secondary">‚Üê Voltar</a>
</div>

<form method="POST" action="/compras/nova" class="form-card">
  <div class="form-row">
    <div class="form-group">
      <label>Data da Compra *</label>
      <input type="date" name="date" value="<%= new Date().toISOString().split('T')[0] %>" required>
    </div>
    <div class="form-group">
      <label>Fornecedor</label>
      <input type="text" name="supplierName" placeholder="Nome do fornecedor">
    </div>
  </div>

  <hr>
  <h3 style="font-size: var(--font-size-sm); font-weight:700; text-transform:uppercase; letter-spacing:.05em; color:var(--text-secondary); margin-bottom:var(--spacing-lg);">Itens da Compra</h3>

  <div class="table-wrapper" style="margin-bottom: var(--spacing-lg);">
    <table>
      <thead>
        <tr>
          <th>Produto</th>
          <th style="width:110px;">Quantidade</th>
          <th style="width:150px;">Custo Unit. (R$)</th>
          <th style="width:130px;" class="text-right">Subtotal</th>
          <th style="width:50px;"></th>
        </tr>
      </thead>
      <tbody id="purchase-items">
        <tr class="item-row">
          <td>
            <select name="productIds" required>
              <option value="">Selecione um produto...</option>
              <% products.forEach(p => { %>
                <option value="<%= p.id %>"><%= p.name %></option>
              <% }); %>
            </select>
          </td>
          <td>
            <input type="number" name="quantities" step="1" min="1"
              placeholder="0" required style="width:90px; text-align:center;">
          </td>
          <td>
            <input type="number" step="0.01" min="0" name="costs"
              placeholder="0,00" required style="width:120px;">
          </td>
          <td class="text-right currency" style="font-weight:600;">
            R$ <span class="subtotal">0,00</span>
          </td>
          <td>
            <button type="button" class="btn btn-sm btn-danger remove-item">‚úï</button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <button type="button" id="add-item" class="btn btn-secondary btn-sm" style="margin-bottom: var(--spacing-xl);">
    + Adicionar Item
  </button>

  <div class="form-actions">
    <button type="submit" class="btn btn-primary btn-lg">üíæ Registrar Compra</button>
    <a href="/compras" class="btn btn-secondary">Cancelar</a>
  </div>
</form>

<script>
document.getElementById('add-item').addEventListener('click', function() {
  var tbody = document.getElementById('purchase-items');
  var row = document.querySelector('.item-row').cloneNode(true);
  row.querySelectorAll('input').forEach(function(el) { el.value = ''; });
  row.querySelectorAll('select').forEach(function(el) { el.value = ''; });
  row.querySelector('.subtotal').textContent = '0,00';
  attachRow(row);
  tbody.appendChild(row);
});

function attachRow(row) {
  function recalc() {
    var qty  = parseInt(row.querySelector('input[name="quantities"]').value, 10) || 0;
    var cost = parseFloat(row.querySelector('input[name="costs"]').value) || 0;
    row.querySelector('.subtotal').textContent = (qty * cost).toFixed(2).replace('.', ',');
  }
  row.querySelector('input[name="quantities"]').addEventListener('input', recalc);
  row.querySelector('input[name="costs"]').addEventListener('input', recalc);
  row.querySelector('.remove-item').addEventListener('click', function() {
    if (document.querySelectorAll('.item-row').length > 1) row.remove();
  });
}

attachRow(document.querySelector('.item-row'));
</script>
