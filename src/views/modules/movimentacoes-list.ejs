<%
// ‚îÄ‚îÄ label/badge helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function motivoLabel(reason) {
  var map = {
    'VENDA':          { label: 'Venda',          cls: 'badge-warning'   },
    'COMPRA':         { label: 'Compra',          cls: 'badge-primary'   },
    'PRODU√á√ÉO':       { label: 'Produ√ß√£o',        cls: 'badge-success'   },
    'CANCELAMENTO':   { label: 'Cancelamento',    cls: 'badge-secondary' },
    'ESTORNO_COMPRA': { label: 'Estorno Compra',  cls: 'badge-danger'    },
    'AJUSTE':         { label: 'Ajuste',          cls: 'badge-secondary' },
  };
  return map[reason] || { label: reason || '‚Äî', cls: 'badge-secondary' };
}

function refLabel(refId, refType) {
  if (!refId) return '‚Äî';
  if (refType === 'SALE')              return 'Venda #' + refId;
  if (refType === 'PURCHASE')          return 'Compra #' + (refId + '').replace('PURCHASE_', '');
  if (refType === 'PURCHASE_REVERSAL') return 'Estorno Compra #' + (refId + '').replace('PURCHASE_','').replace('_REVERSAL','');
  if (refType === 'BATCH')             return 'Lote #' + refId;
  return refId;
}
// totalEntradas, totalSaidas, somaEntradas, somaSaidas are passed from server (period totals)
%>

<div class="page-header">
  <div>
    <h1>Movimenta√ß√µes</h1>
    <p style="margin:0; color:var(--text-secondary);">Hist√≥rico completo de todas as movimenta√ß√µes de estoque</p>
  </div>
</div>

<!-- Filters -->
<div class="filter-bar">
  <div class="filter-group">
    <label>Data Inicial</label>
    <input type="date" id="fStart" value="<%= startDate %>">
  </div>
  <div class="filter-group">
    <label>Data Final</label>
    <input type="date" id="fEnd" value="<%= endDate %>">
  </div>
  <div class="filter-group">
    <label>Tipo</label>
    <select id="fTipo" style="max-width:160px;">
      <option value="TODOS"  <%= tipoFilter === 'TODOS' ? 'selected' : '' %>>Todos</option>
      <option value="IN"     <%= tipoFilter === 'IN'    ? 'selected' : '' %>>Entradas</option>
      <option value="OUT"    <%= tipoFilter === 'OUT'   ? 'selected' : '' %>>Sa√≠das</option>
    </select>
  </div>
  <div class="filter-group">
    <label>Motivo</label>
    <select id="fMotivo" style="max-width:200px;">
      <option value="TODOS"          <%= motivoFilter === 'TODOS'          ? 'selected' : '' %>>Todos</option>
      <option value="VENDA"          <%= motivoFilter === 'VENDA'          ? 'selected' : '' %>>Venda</option>
      <option value="COMPRA"         <%= motivoFilter === 'COMPRA'         ? 'selected' : '' %>>Compra</option>
      <option value="PRODU√á√ÉO"       <%= motivoFilter === 'PRODU√á√ÉO'       ? 'selected' : '' %>>Produ√ß√£o</option>
      <option value="CANCELAMENTO"   <%= motivoFilter === 'CANCELAMENTO'   ? 'selected' : '' %>>Cancelamento</option>
      <option value="ESTORNO_COMPRA" <%= motivoFilter === 'ESTORNO_COMPRA' ? 'selected' : '' %>>Estorno Compra</option>
      <option value="AJUSTE"         <%= motivoFilter === 'AJUSTE'         ? 'selected' : '' %>>Ajuste</option>
    </select>
  </div>
  <div class="filter-group" style="flex:0;">
    <label>&nbsp;</label>
    <button class="btn btn-primary" onclick="applyFilter()">Filtrar</button>
  </div>
</div>

<div class="quick-filters">
  <button class="quick-filter-btn" onclick="setQuick('today')">Hoje</button>
  <button class="quick-filter-btn" onclick="setQuick('yesterday')">Ontem</button>
  <button class="quick-filter-btn" onclick="setQuick('week')">Esta Semana</button>
  <button class="quick-filter-btn" onclick="setQuick('month')">Este M√™s</button>
  <button class="quick-filter-btn" onclick="setQuick('all')">Tudo</button>
</div>

<!-- Summary cards (period totals, not just current page) -->
<div class="dashboard-grid" style="margin-bottom:var(--spacing-xl);">
  <div class="stat-card">
    <div class="stat-label">Total no Per√≠odo</div>
    <div class="stat-value"><%= total %></div>
  </div>
  <div class="stat-card success">
    <div class="stat-label">Entradas (<%= totalEntradas %>)</div>
    <div class="stat-value">+<%= somaEntradas.toFixed(0) %> un.</div>
  </div>
  <div class="stat-card" style="border-left:4px solid var(--color-danger,#ef4444);">
    <div class="stat-label">Sa√≠das (<%= totalSaidas %>)</div>
    <div class="stat-value" style="color:var(--color-danger,#ef4444);"><%= Math.abs(somaSaidas).toFixed(0) %> un.</div>
  </div>
</div>

<% if (total > 0) { %>
<!-- Search bar (client-side) -->
<div style="margin-bottom:var(--spacing-md);">
  <input type="text" id="searchInput" placeholder="Buscar por produto, motivo ou refer√™ncia..."
    oninput="filterTable()" style="max-width:400px;">
</div>

<div class="table-wrapper">
  <table id="movTable">
    <thead>
      <tr>
        <th style="width:140px;">Data / Hora</th>
        <th>Produto</th>
        <th style="width:90px; text-align:center;">Tipo</th>
        <th style="width:90px; text-align:center;">Qtd.</th>
        <th style="width:130px;">Motivo</th>
        <th>Refer√™ncia</th>
      </tr>
    </thead>
    <tbody>
      <% movements.forEach(function(m) { %>
      <%
        var isIn    = m.quantity > 0;
        var motivo  = motivoLabel(m.reason);
        var ref     = refLabel(m.referenceId, m.referenceType);
        var qtySign = isIn ? '+' : '';
        var qtyColor = isIn ? 'var(--color-success,#22c55e)' : 'var(--color-danger,#ef4444)';
        var dt = new Date(m.createdAt);
      %>
      <tr class="mov-row">
        <td style="white-space:nowrap; font-size:var(--font-size-xs);">
          <div style="font-weight:600;"><%= dt.toLocaleDateString('pt-BR') %></div>
          <div style="color:var(--text-secondary);"><%= dt.toLocaleTimeString('pt-BR', {hour:'2-digit',minute:'2-digit'}) %></div>
        </td>
        <td>
          <strong><%= m.product ? m.product.name : '‚Äî' %></strong>
        </td>
        <td style="text-align:center;">
          <% if (isIn) { %>
            <span style="font-weight:700; color:var(--color-success,#22c55e); font-size:1.1em;">‚Üë</span>
            <span style="font-size:var(--font-size-xs); color:var(--color-success,#22c55e);">Entrada</span>
          <% } else { %>
            <span style="font-weight:700; color:var(--color-danger,#ef4444); font-size:1.1em;">‚Üì</span>
            <span style="font-size:var(--font-size-xs); color:var(--color-danger,#ef4444);">Sa√≠da</span>
          <% } %>
        </td>
        <td style="text-align:center; font-weight:700; font-size:1.05em; color:<%= qtyColor %>;">
          <%= qtySign %><%= Math.abs(m.quantity) %>
        </td>
        <td>
          <span class="badge <%= motivo.cls %>"><%= motivo.label %></span>
        </td>
        <td style="font-size:var(--font-size-xs); color:var(--text-secondary);">
          <%= ref %>
        </td>
      </tr>
      <% }); %>
    </tbody>
  </table>
</div>

<!-- Pagination -->
<% if (totalPages > 1) { %>
<div style="display:flex; align-items:center; justify-content:center; gap:12px; margin-top:var(--spacing-lg);">
  <% if (page > 1) { %>
    <a href="?startDate=<%= startDate %>&endDate=<%= endDate %>&tipo=<%= encodeURIComponent(tipoFilter) %>&motivo=<%= encodeURIComponent(motivoFilter) %>&page=<%= page - 1 %>"
       class="btn btn-secondary" style="padding:6px 16px;">‚Üê Anterior</a>
  <% } else { %>
    <button class="btn btn-secondary" disabled style="padding:6px 16px; opacity:.4;">‚Üê Anterior</button>
  <% } %>

  <span style="font-size:var(--font-size-sm); color:var(--text-secondary);">
    P√°gina <strong><%= page %></strong> de <strong><%= totalPages %></strong>
    &nbsp;¬∑&nbsp; <strong><%= total %></strong> registro(s)
  </span>

  <% if (page < totalPages) { %>
    <a href="?startDate=<%= startDate %>&endDate=<%= endDate %>&tipo=<%= encodeURIComponent(tipoFilter) %>&motivo=<%= encodeURIComponent(motivoFilter) %>&page=<%= page + 1 %>"
       class="btn btn-secondary" style="padding:6px 16px;">Pr√≥xima ‚Üí</a>
  <% } else { %>
    <button class="btn btn-secondary" disabled style="padding:6px 16px; opacity:.4;">Pr√≥xima ‚Üí</button>
  <% } %>
</div>
<% } else { %>
<p style="text-align:center; color:var(--text-secondary); font-size:var(--font-size-sm); margin-top:var(--spacing-md);">
  <strong><%= total %></strong> registro(s) no per√≠odo
</p>
<% } %>

<% } else { %>
<div class="empty-state">
  <div class="empty-state-icon">üìã</div>
  <div class="empty-state-title">Nenhuma movimenta√ß√£o no per√≠odo</div>
  <p>Registre vendas, compras ou lotes para ver as movimenta√ß√µes aqui.</p>
</div>
<% } %>

<script>
function applyFilter() {
  var start  = document.getElementById('fStart').value;
  var end    = document.getElementById('fEnd').value;
  var tipo   = document.getElementById('fTipo').value;
  var motivo = document.getElementById('fMotivo').value;
  var url = '/movimentacoes?startDate=' + start + '&endDate=' + end +
            '&tipo=' + encodeURIComponent(tipo) + '&motivo=' + encodeURIComponent(motivo) + '&page=1';
  window.location.href = url;
}

function setQuick(period) {
  var today = new Date();
  var start = new Date(today);
  var end   = new Date(today);
  if (period === 'yesterday') {
    start.setDate(today.getDate() - 1);
    end = new Date(start);
  } else if (period === 'week') {
    start.setDate(today.getDate() - today.getDay());
  } else if (period === 'month') {
    start.setDate(1);
  } else if (period === 'all') {
    start = new Date('2020-01-01');
  }
  document.getElementById('fStart').value = start.toISOString().split('T')[0];
  document.getElementById('fEnd').value   = end.toISOString().split('T')[0];
  applyFilter();
}

// Client-side search filter
function filterTable() {
  var term = document.getElementById('searchInput').value.toLowerCase();
  document.querySelectorAll('#movTable tbody .mov-row').forEach(function(row) {
    var text = row.textContent.toLowerCase();
    row.style.display = text.includes(term) ? '' : 'none';
  });
}
</script>
