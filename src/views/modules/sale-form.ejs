<div class="page-header">
  <div>
    <h1>Nova Venda</h1>
    <p>Registrar venda de produtos</p>
  </div>
  <a href="/vendas" class="btn btn-secondary">Ver Vendas</a>
</div>

<% if (typeof success !== 'undefined' && success) { %>
  <div class="alert alert-success">
    âœ… Venda registrada com sucesso! VocÃª pode registrar uma nova venda abaixo.
  </div>
<% } %>

<form method="POST" action="/vendas" class="form-card">

  <!-- Customer -->
  <div class="form-group" style="max-width: 480px;">
    <label>Cliente *</label>
    <select name="customerId" required>
      <option value="">Selecione um cliente...</option>
      <% customers.forEach(c => { %>
        <option value="<%= c.id %>"><%= c.name %></option>
      <% }); %>
    </select>
  </div>

  <hr>
  <h3 style="font-size:var(--font-size-sm);font-weight:700;text-transform:uppercase;letter-spacing:.05em;color:var(--text-secondary);margin-bottom:var(--spacing-lg);">Itens da Venda</h3>

  <div class="table-wrapper" style="margin-bottom:var(--spacing-lg);">
    <table id="sale-table">
      <thead>
        <tr>
          <th>Produto</th>
          <th style="width:90px;">Qtd.</th>
          <th style="width:150px;">PreÃ§o Unit.</th>
          <th style="width:130px;" class="text-right">Subtotal</th>
          <th style="width:90px;text-align:center;" title="Cobrar depÃ³sito de garrafa retornÃ¡vel?">DepÃ³sito?</th>
          <th style="width:50px;"></th>
        </tr>
      </thead>
      <tbody id="sale-items">
        <tr class="item-row">
          <td>
            <select name="productIds" class="product-select" required>
              <option value="">Selecione um produto...</option>
              <% products.forEach(p => { %>
                <option value="<%= p.id %>" data-price="<%= p.priceUnit %>">
                  <%= p.name %><% if (p.isReturnable) { %> ðŸ”„<% } %>
                </option>
              <% }); %>
            </select>
          </td>
          <td>
            <input type="number" name="quantities" step="1" min="1"
              placeholder="0" required class="qty-input"
              style="width:76px;text-align:center;">
          </td>
          <td>
            <div style="display:flex;align-items:center;gap:4px;">
              <span style="color:var(--text-muted);font-size:var(--font-size-sm);white-space:nowrap;">R$</span>
              <input type="number" step="0.01" min="0" name="prices"
                placeholder="â€”" class="price-input"
                style="width:104px;" readonly>
            </div>
          </td>
          <td class="text-right currency" style="font-weight:600;">
            R$ <span class="subtotal">0,00</span>
          </td>
          <td class="deposit-cell" style="text-align:center;display:none;">
            <input type="hidden" name="depositEnabled" value="0" class="deposit-hidden">
            <input type="checkbox" class="deposit-check" style="width:auto;cursor:pointer;" title="Cobrar depÃ³sito de garrafa retornÃ¡vel" checked>
          </td>
          <td>
            <button type="button" class="btn btn-sm btn-danger remove-item">âœ•</button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <button type="button" id="add-item" class="btn btn-secondary btn-sm" style="margin-bottom:var(--spacing-xl);">
    + Adicionar Produto
  </button>

  <hr>

  <!-- Bottom: Payment + Totals -->
  <div style="display:flex;gap:var(--spacing-2xl);flex-wrap:wrap;align-items:flex-start;">

    <!-- Left: Payment + Submit -->
    <div style="flex:1;min-width:220px;">
      <div class="form-group">
        <label>MÃ©todo de Pagamento *</label>
        <select name="paymentMethod" id="paymentMethod" required style="max-width:280px;">
          <option value="DINHEIRO">ðŸ’° Dinheiro</option>
          <option value="PIX">ðŸ“± Pix</option>
          <option value="CARTÃƒO">ðŸ’³ CartÃ£o</option>
        </select>
      </div>

      <!-- Card fee â€” shown only when CARTÃƒO is selected -->
      <div class="form-group" id="card-fee-group" style="display:none;max-width:320px;">
        <label>Taxa do CartÃ£o</label>
        <div style="display:flex;gap:20px;margin-bottom:8px;">
          <label style="font-weight:normal;display:flex;align-items:center;gap:6px;cursor:pointer;">
            <input type="radio" name="cardFeeType" value="PCT" checked> Porcentagem (%)
          </label>
          <label style="font-weight:normal;display:flex;align-items:center;gap:6px;cursor:pointer;">
            <input type="radio" name="cardFeeType" value="BRL"> Valor fixo (R$)
          </label>
        </div>
        <input type="number" name="cardFeeRate" id="cardFeeRate"
          step="0.01" min="0" max="100" placeholder="ex: 2.5" value="0"
          style="max-width:140px;">
        <div class="form-hint" id="card-fee-hint">A taxa em % serÃ¡ acrescentada ao total</div>
      </div>

      <div class="form-actions" style="margin-top:var(--spacing-xl);">
        <button type="submit" class="btn btn-success btn-lg">âœ… Confirmar Venda</button>
        <a href="/dashboard" class="btn btn-secondary">Cancelar</a>
      </div>
    </div>

    <!-- Right: Totals -->
    <div class="sales-totals" style="flex:0 0 320px;margin:0;">
      <h3>Resumo</h3>
      <div class="total-row">
        <span class="total-label">Subtotal</span>
        <span class="currency total-value" id="subtotal">R$ 0,00</span>
      </div>
      <div class="total-row" style="align-items:center;">
        <label class="total-label" for="discount" style="margin:0;">Desconto (%)</label>
        <input type="number" name="discount" id="discount"
          step="0.01" min="0" max="100" placeholder="0" value="0"
          style="width:70px;text-align:right;padding:4px 8px;">
      </div>
      <div class="total-row">
        <span class="total-label">Desconto (R$)</span>
        <span class="currency total-value" id="discount-value">R$ 0,00</span>
      </div>
      <!-- Deposit row â€” visible only if any item has deposit enabled -->
      <div class="total-row" id="deposit-row" style="display:none;">
        <span class="total-label">ðŸ”„ DepÃ³sito garrafas</span>
        <span class="currency total-value" id="deposit-value">R$ 0,00</span>
      </div>
      <!-- Card fee row â€” visible only when CARTÃƒO -->
      <div class="total-row" id="card-fee-row" style="display:none;">
        <span class="total-label" id="card-fee-label">Taxa cartÃ£o</span>
        <span class="currency total-value" id="card-fee-value">R$ 0,00</span>
      </div>
      <div class="total-row grand-total">
        <span class="total-label">TOTAL</span>
        <span class="currency total-value" id="total">R$ 0,00</span>
      </div>
    </div>

  </div>

</form>

<style>
.price-input[readonly] {
  background: #f1f5f9;
  color: var(--text-primary);
  cursor: default;
  font-weight: 600;
}
</style>

<!-- Product data: JSON, no EJS inside script blocks -->
<script id="product-data" type="application/json"><%- JSON.stringify(products.map(function(p){ return { id: p.id, price: p.priceUnit, returnable: p.isReturnable, depositValue: p.depositValue || 5 }; })) %></script>

<script>
var PRODUCT_DATA = {};
JSON.parse(document.getElementById('product-data').textContent).forEach(function(p) {
  PRODUCT_DATA[p.id] = { price: p.price, returnable: p.returnable, depositValue: p.depositValue || 5 };
});

// Add item row
document.getElementById('add-item').addEventListener('click', function() {
  var tbody = document.getElementById('sale-items');
  var row = document.querySelector('.item-row').cloneNode(true);
  row.querySelectorAll('input').forEach(function(el) {
    if (el.type !== 'hidden') el.value = '';
    if (el.type === 'checkbox') el.checked = false;
  });
  row.querySelectorAll('select').forEach(function(el) { el.value = ''; });
  row.querySelector('.subtotal').textContent = '0,00';
  row.querySelector('.deposit-cell').style.display = 'none';
  row.querySelector('.deposit-hidden').value = '0';
  row.querySelector('.deposit-check').checked = false;
  attachRowEvents(row);
  tbody.appendChild(row);
});

function attachRowEvents(row) {
  row.querySelector('.product-select').addEventListener('change', function() {
    var pid = this.value;
    var priceInput    = row.querySelector('.price-input');
    var depositCell   = row.querySelector('.deposit-cell');
    var depositHidden = row.querySelector('.deposit-hidden');
    var depositCheck  = row.querySelector('.deposit-check');

    if (pid && PRODUCT_DATA[pid]) {
      priceInput.value = parseFloat(PRODUCT_DATA[pid].price).toFixed(2);
      if (PRODUCT_DATA[pid].returnable) {
        depositCell.style.display = 'table-cell';
        depositCheck.checked = true;
        depositHidden.value = '1';
      } else {
        depositCell.style.display = 'none';
        depositCheck.checked = false;
        depositHidden.value = '0';
      }
    } else {
      priceInput.value = '';
      depositCell.style.display = 'none';
      depositCheck.checked = false;
      depositHidden.value = '0';
    }
    updateTotals();
  });

  row.querySelector('.qty-input').addEventListener('input', updateTotals);

  row.querySelector('.deposit-check').addEventListener('change', function() {
    row.querySelector('.deposit-hidden').value = this.checked ? '1' : '0';
    updateTotals();
  });

  row.querySelector('.remove-item').addEventListener('click', function() {
    if (document.querySelectorAll('.item-row').length > 1) {
      row.remove();
      updateTotals();
    }
  });
}

attachRowEvents(document.querySelector('.item-row'));

// Show/hide card fee group
document.getElementById('paymentMethod').addEventListener('change', function() {
  var isCard = this.value === 'CARTÃƒO';
  document.getElementById('card-fee-group').style.display = isCard ? 'block' : 'none';
  document.getElementById('card-fee-row').style.display  = isCard ? 'flex' : 'none';
  updateTotals();
});

// Card fee type toggle
document.querySelectorAll('input[name="cardFeeType"]').forEach(function(r) {
  r.addEventListener('change', function() {
    var isPct = this.value === 'PCT';
    var rateInput = document.getElementById('cardFeeRate');
    rateInput.max = isPct ? '100' : '';
    rateInput.placeholder = isPct ? 'ex: 2.5' : 'ex: 3.50';
    document.getElementById('card-fee-hint').textContent = isPct
      ? 'A taxa em % serÃ¡ acrescentada ao total'
      : 'O valor fixo em R$ serÃ¡ acrescentado ao total';
    updateTotals();
  });
});

document.getElementById('discount').addEventListener('input', updateTotals);
document.getElementById('cardFeeRate').addEventListener('input', updateTotals);

function getCardFeeType() {
  var checked = document.querySelector('input[name="cardFeeType"]:checked');
  return checked ? checked.value : 'PCT';
}

function updateTotals() {
  var subtotal     = 0;
  var depositTotal = 0;

  document.querySelectorAll('.item-row').forEach(function(row) {
    var pid   = row.querySelector('.product-select').value;
    var qty   = Math.max(0, parseInt(row.querySelector('.qty-input').value, 10) || 0);
    var price = parseFloat(row.querySelector('.price-input').value) || 0;
    var sub   = qty * price;
    row.querySelector('.subtotal').textContent = sub.toFixed(2).replace('.', ',');
    subtotal += sub;

    var depositHidden = row.querySelector('.deposit-hidden');
    if (pid && PRODUCT_DATA[pid] && PRODUCT_DATA[pid].returnable && depositHidden && depositHidden.value === '1') {
      depositTotal += qty * PRODUCT_DATA[pid].depositValue;
    }
  });

  var discountPct  = parseFloat(document.getElementById('discount').value) || 0;
  var discountVal  = (subtotal * discountPct) / 100;
  var afterDiscount = subtotal - discountVal;

  var isCard      = document.getElementById('paymentMethod').value === 'CARTÃƒO';
  var cardFeeVal  = 0;
  var cardFeeLabel = 'Taxa cartÃ£o';
  if (isCard) {
    var rate    = parseFloat(document.getElementById('cardFeeRate').value) || 0;
    var feeType = getCardFeeType();
    cardFeeVal  = feeType === 'PCT' ? (afterDiscount * rate) / 100 : rate;
    cardFeeLabel = feeType === 'PCT'
      ? 'Taxa cartÃ£o (' + rate.toFixed(1) + '%)'
      : 'Taxa cartÃ£o (R$ ' + rate.toFixed(2).replace('.', ',') + ')';
  }

  var total = afterDiscount + cardFeeVal + depositTotal;

  document.getElementById('subtotal').textContent       = 'R$ ' + subtotal.toFixed(2).replace('.', ',');
  document.getElementById('discount-value').textContent = 'R$ ' + discountVal.toFixed(2).replace('.', ',');
  document.getElementById('card-fee-label').textContent = cardFeeLabel;
  document.getElementById('card-fee-value').textContent = 'R$ ' + cardFeeVal.toFixed(2).replace('.', ',');
  document.getElementById('deposit-value').textContent  = 'R$ ' + depositTotal.toFixed(2).replace('.', ',');
  document.getElementById('total').textContent          = 'R$ ' + total.toFixed(2).replace('.', ',');

  document.getElementById('deposit-row').style.display = depositTotal > 0 ? 'flex' : 'none';
}

updateTotals();
</script>
